<!DOCTYPE HTML><html><head>
<style>
img {width: 80px;height: auto;}
.hover {position: relative;top: 50px;left: 50px;}
.dot {height:15px;width:15px;border-radius:7px;display:inline-block;}
.dot.pointer {cursor: pointer;}
input[type="range"] {width:50px;}
</style><title>JRMI Accessory MQTT Client Configuration</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script>

function getValue(radio) {
alert(radio.value);}

if (!!window.EventSource) {
var source = new EventSource('/events');}

source.addEventListener('Alert', function(e){ 
var strmsg = "Only enter integer values...";
alert("Error updating system name!\n" + strmsg);
}, false);

source.addEventListener('AlertMQTT', function(e){
var strmsg = "Check broker is running and that the IP/port are correct..." ;
alert("Problem connecting to MQTT Broker!\n" + strmsg);
}, false);

function radioClick(elem){
//console.log(elem);
var bid = elem.parentNode.parentNode.id;
var pid = elem.parentNode.id;
var elemid = elem.id;

var params = "bname=" + bid + "&name=" +  pid + "&mode=" + elemid;
//console.log(params);

var xhr = new XMLHttpRequest();
xhr.open("POST", "/changeradio", true);
xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
xhr.send(params);}

function slider(elem){
var bid = elem.parentNode.parentNode.parentNode.id;
var pid = elem.parentNode.parentNode.id;
var elemid = elem.id;
var params = "board=" + bid + "&pin=" + pid + "&value=" + elem.value ;
//console.log(params);
var xhr = new XMLHttpRequest();              
xhr.open("POST", "/rangeChange", true);
xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
xhr.send(params); }

function dot_click(element) {
var sysname = element.parentNode.children[0].value;
var state = element.dataset.state;
//we flip the state here
if (state == 'T'){
  state = 'C';
} else if (state == 'C'){
  state = 'T';
} else if (state == 'A'){
  state = 'I';
} else if (state == 'I'){
  state = 'A';
} else if (state == 'N'){
  state = 'F';
} else if (state == 'F'){
  state = 'N';
}
var params = "sysname=" + sysname + "&state=" + state;
//console.log(params);
var xhr = new XMLHttpRequest();              
xhr.open("POST", "/dot_button_click", true);
xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
xhr.send(params);}

source.addEventListener('dotEnable', function(e){ 
//console.log('dotEnable', e.data);
const mySplit = e.data.split(":");
if (mySplit[1] == 'on') {
    //console.log('on');
    document.getElementById(mySplit[0]).className = 'dot pointer';
    document.getElementById(mySplit[0]).setAttribute ( 'onclick', 'dot_click(this);');
} else {
    //console.log('off');
    document.getElementById(mySplit[0]).className = 'dot';
    document.getElementById(mySplit[0]).setAttribute ( 'onclick', ' ');
}}, false);

source.addEventListener('moveSlider', function(e){ 
//console.log('MoveSlider', e.data);
const sinfo = e.data.split(":");
document.getElementById(sinfo[0]).value = sinfo[1];
}, false);

source.addEventListener('sliderEnable', function(e){ 
//console.log('SliderEnable', e.data);
const sinfo = e.data.split(":");
document.getElementById(sinfo[0]).value = sinfo[2];
if ( sinfo[1] == 'off' ){
  document.getElementById(sinfo[0]).disabled = true;
} else {
  document.getElementById(sinfo[0]).disabled = false;
}}, false);

source.addEventListener('setDot', function(e){ 
//console.log('SetDot', e.data);
const Supdate = e.data.split(":");
document.getElementById(Supdate[0]).setAttribute('data-state',Supdate[1]);
if ( Supdate[1] == 'I' || Supdate[1] == 'C' || Supdate[1] == 'F' ){
  document.getElementById(Supdate[0]).style.backgroundColor = "red";
} else {
  document.getElementById(Supdate[0]).style.backgroundColor = "green";
}}, false);

</script></head><body>
<a href="https://www.jmri.org/"> 
<img src="https://www.jmri.org/images/logo-jmri.gif" alt="JMRI"></a>
<h1>JRMI Accessory MQTT Client Configuration.</h1>
<p>Client IP Address: %CLIENTADDRESS%</p>
<p>Client MAC Address: %CLIENTMACADDRESS%</p>

<form action="/get">
MQTT Broker IP:    <input type="text" id="mqttip" name="MQTTHostIp" value="%MQTTHOST%">
MQTT Broker Port:  <input type="text" id="mqttport" name="MQTTHostPort" value="%MQTTPORT%"><br><br>
MQTT Topic:  <input type="text" id="mqtttopic" name="MQTTTopic" value="%MQTTTOPIC%">&nbsp;&nbsp;default: /trains/track/#<br>
<p>Enter JMRI MQTT system names (excluding leading "MS/MT") and set to Sensor or Turnout. "0" means unused.</p>
<p>Turnout state can be changed by clicking the green/red circle.<p>

<div id='b0'>
<div id='0'>
 Pin 0 <input type='text' id='0pin0' name='0pin0' value='%0pin0val%'>
 <input type='radio' id='S' name='0mod0' value='S' onchange='radioClick(this)' disabled >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod0' value='T' onchange='radioClick(this)' %0pin0rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk0' name='0chk0 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod0' value='L' onchange='radioClick(this)' %0pin0rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin0style%"    id='0dot0' class='%0pin0dot%' data-state='%0pin0sdatas%' %0pin0att% ></span>
<span class='slider'><input %0pin0sdis% id='0sli0' type='range' min='0' max='255' value='%0pin0sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='1'>
 Pin 1 <input type='text' id='0pin1' name='0pin1' value='%0pin1val%'>
 <input type='radio' id='S' name='0mod1' value='S' onchange='radioClick(this)' %0pin1rad0% >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod1' value='T' onchange='radioClick(this)'  %0pin1rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk1' name='0chk1 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod1' value='L' onchange='radioClick(this)'  %0pin1rad2%>
<label for='light'>Light</label>
<span style="background-color:%0pin1style%"    id='0dot1' class='%0pin1dot%' data-state='%0pin1sdatas%' %0pin1att% ></span>
<span class='slider'><input %0pin1sdis% id='0sli1' type='range' min='0' max='255' value='%0pin1sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='2'>
 Pin 2 <input type='text' id='0pin2' name='0pin2' value='%0pin2val%'>
 <input type='radio' id='S' name='0mod2' value='S' onchange='radioClick(this)' %0pin2rad0% >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod2' value='T' onchange='radioClick(this)'  %0pin2rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk2' name='0chk2 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod2' value='L' onchange='radioClick(this)'  %0pin2rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin2style%"    id='0dot2' class='%0pin2dot%' data-state='%0pin2sdatas%' %0pin2att% ></span>
<span class='slider'><input %0pin2sdis% id='0sli2' type='range' min='0' max='255' value='%0pin2sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='3'>
 Pin 3 <input type='text' id='0pin3' name='0pin3' value='%0pin3val%'>
 <input type='radio' id='S' name='0mod3' value='S' onchange='radioClick(this)' disabled >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod3' value='T' onchange='radioClick(this)' %0pin3rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk3' name='0chk3 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod3' value='L' onchange='radioClick(this)'  %0pin3rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin3style%"    id='0dot3' class='%0pin3dot%' data-state='%0pin3sdatas%' %0pin3att%></span>
<span class='slider'><input %0pin3sdis% id='0sli3' type='range' min='0' max='255' value='%0pin3sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='4'>
 Pin 4 <input type='text' id='0pin4' name='0pin4' value='%0pin4val%'>
 <input type='radio' id='S' name='0mod4' value='S' onchange='radioClick(this)' disabled >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod4' value='T' onchange='radioClick(this)' %0pin4rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk4' name='0chk4 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod4' value='L' onchange='radioClick(this)' %0pin4rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin4style%"    id='0dot4' class='%0pin4dot%' data-state='%0pin4sdatas%' %0pin4att% ></span>
<span class='slider'><input %0pin4sdis% id='0sli4' type='range' min='0' max='255' value='%0pin4sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='5'>
 Pin 5 <input type='text' id='0pin5' name='0pin5' value='%0pin5val%'>
 <input type='radio' id='S' name='0mod5' value='S' onchange='radioClick(this)' %0pin5rad0% >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod5' value='T' onchange='radioClick(this)' %0pin5rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk5' name='0chk5 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod5' value='L' onchange='radioClick(this)' %0pin5rad2%  >
<label for='light'>Light</label>
<span style="background-color:%0pin5style%"    id='0dot5' class='%0pin5dot%' data-state='%0pin5sdatas%' %0pin5att% ></span>
<span class='slider'><input %0pin5sdis% id='0sli5' type='range' min='0' max='255' value='%0pin5sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='6'>
 Pin 6 <input type='text' id='0pin6' name='0pin6' value='%0pin6val%'>
 <input type='radio' id='S' name='0mod6' value='S' onchange='radioClick(this)' %0pin6rad0% >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod6' value='T' onchange='radioClick(this)' %0pin6rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk6' name='0chk6 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod6' value='L' onchange='radioClick(this)' %0pin6rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin6style%"    id='0dot6' class='%0pin6dot%' data-state='%0pin6sdatas%' %0pin6att% ></span>
<span class='slider'><input %0pin6sdis% id='0sli6' type='range' min='0' max='255' value='%0pin6sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='7'>
 Pin 7 <input type='text' id='0pin7' name='0pin7' value='%0pin7val%'>
 <input type='radio' id='S' name='0mod7' value='S' onchange='radioClick(this)' %0pin7rad0% >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod7' value='T' onchange='radioClick(this)' %0pin7rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk7' name='0chk7 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='0mod7' value='L' onchange='radioClick(this)' %0pin7rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin7style%"    id='0dot7' class='%0pin7dot%' data-state='%0pin7sdatas%' %0pin7att% ></span>
<span class='slider'><input %0pin7sdis% id='0sli7' type='range' min='0' max='255' value='%0pin7sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
<div id='8'>
 Pin 8 <input type='text' id='0pin8' name='0pin8' value='%0pin8val%'>
 <input type='radio' id='S' name='0mod8' value='S' onchange='radioClick(this)' disabled >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='0mod8' value='T' onchange='radioClick(this)' %0pin8rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='0chk8' name='0chk8 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id=-'L' name='0mod8' value='L' onchange='radioClick(this)' %0pin8rad2% >
<label for='light'>Light</label>
<span style="background-color:%0pin8style%"    id='0dot8' class='%0pin8dot%' data-state='%0pin8sdatas%' %0pin8att% ></span>
<span class='slider'><input %0pin8sdis% id='0sli8' type='range' min='0' max='255' value='%0pin8sval%' onchange='slider(this)' oninput='slider(this)'><span></div>
</div>

<div id='b0'>
<div id='0'>
 Pin 0 <input type='text' id='1pin0' name='1pin0' value='%1pin0val%'>
 <input type='radio' id='S' name='1mod0' value='S' onchange='radioClick(this)' disabled >
<label for='sensor'>Sensor</label>
<input type='radio' id='T' name='1mod0' value='T' onchange='radioClick(this)' %1pin0rad1% >
<label for='turnout'>Turnout</label>
<input type='checkbox' id='1chk0' name='1chk0 checked '> <label for='pwmcheck'>PWM</label>
<input type='radio' id='L' name='1mod0' value='L' onchange='radioClick(this)' %1pin0rad2% >
<label for='light'>Light</label>
<span style="background-color:%1pin0style%"    id='1dot0' class='%1pin0dot%' data-state='%1pin0sdatas%' %1pin0att% ></span>
<span class='slider'><input %1pin0sdis% id='1sli0' type='range' min='0' max='255' value='%1pin0sval%' onchange='slider(this)' oninput='slider(this)'><span></div>


</div>

<span style="background-color:green;" class="dot"></span>&nbsp;ACTIVE/THROWN/ON<br>
<span style="background-color:red;" class="dot"></span>&nbsp;INACTIVE/CLOSED/OFF<br><br>
<input type="submit" value="Save" title="Save changes to EEPROM"></form><br>
<br><br><button type="button" onclick="location.href='/reset_eeprom'">Reset Configuration</button>  
</body></html>
